---
kind: Deployment
replicaCount: 1

serviceAccount:
  create: true
rbac:
  create: true
  nodeAccess: true
  eventsAccess: true

serviceMonitor:
  enabled: true
prometheusRule:
  enabled: true
  additionalLabels:
    alertmanager: metrics
  rules:
    - alert: NoKubernetesEventsProcessed
      expr: |
        rate(
          fluentbit_output_proc_bytes_total{
            name="events"
          }[5m]
        ) == 0
      annotations:
        summary: No Kubernetes Events Processed
        message: |
          The fluent-bit Deployment in {{ $labels.namespace }} has not processed
          any Kubernetes Events in the last fifteen minutes.
      for: 15m
      labels:
        severity: critical

dashboards:
  # This will be deployed by the DaemonSet HelmRelease
  enabled: false

resources:
  limits:
    memory: 128Mi
  requests:
    cpu: 10m
    memory: 16Mi

hotReload:
  enabled: true

extraPorts:
  - port: 2001
    containerPort: 2001
    protocol: TCP
    name: talos
  - port: 5140
    containerPort: 5140
    protocol: TCP
    name: syslog

# ingress:
#   enabled: true
#   ingressClassName: internal
#   annotations:
#     cert-manager.io/cluster-issuer: letsencrypt-cloudflare-production
#   hosts:
#     - host: fluent.${cluster_domain}
#   tls:
#     - hosts:
#         - fluent.${cluster_domain}
#       secretName: ingress-fluent-bit-deployment-tls

updateStrategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1

env:
  - name: FLUENT_ELASTICSEARCH_PASSWORD
    valueFrom:
      secretKeyRef:
        name: fluent-bit-credentials
        key: password

config:
  # yamllint disable rule:line-length
  inputs: |
    [INPUT]
        name kubernetes_events
        alias ${cluster}
        tag kubernetes-events

    [INPUT]
        name tcp
        alias talos-${cluster}
        mode tcp
        listen 0.0.0.0
        port 2001
        buffer_size 128
        chunk_size 1024
        format json
        source_address_key remote
        tag talos

    [INPUT]
        name syslog
        alias tcp-${cluster}
        mode tcp
        listen 0.0.0.0
        port 2001
        buffer_size 128
        chunk_size 1024
        parser syslog-rfc3164
        source_address_key remote
        tag syslog

  # https://docs.fluentbit.io/manual/pipeline/filters
  filters: |
    # All cluster field with the name of the cluster to all log entries to
    # ensure that we can search by cluster
    [FILTER]
        name modify
        alias add-cluster-tag
        match *
        add cluster ${cluster}
        remove logtag

  outputs: |
    [OUTPUT]
        name es
        alias events
        match kubernetes-events
        host logs-es-http.elastic-logs.svc
        # The _type field is not supported by Elasticsearch 8.0.0 or greater
        suppress_type_name on
        http_user fluent-bit
        http_passwd $${FLUENT_ELASTICSEARCH_PASSWORD}
        logstash_format on
        logstash_prefix logs-events
        # Enable nano-second precision as we're using Logstash formats
        time_key_nanos on
        buffer_size 1M

    [OUTPUT]
        name es
        alias talos
        match talos.*
        host logs-es-http.elastic-logs.svc
        suppress_type_name on
        http_user fluent-bit
        http_passwd $${FLUENT_ELASTICSEARCH_PASSWORD}
        logstash_format on
        logstash_prefix logs-talos
        time_key_nanos on
        buffer_size 1M

    [OUTPUT]
        name es
        alias syslog
        match syslog
        host logs-es-http.elastic-logs.svc
        suppress_type_name on
        http_user fluent-bit
        http_passwd $${FLUENT_ELASTICSEARCH_PASSWORD}
        logstash_format on
        logstash_prefix logs-syslog
        time_key_nanos on
        buffer_size 1M
